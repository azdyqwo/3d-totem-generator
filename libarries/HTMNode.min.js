// MIT License

// Copyright (c) 2023 Asaki Zuki

// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:

// The above copyright notice and this permission notice shall be included in all
// copies or substantial portions of the Software.

// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
// SOFTWARE.

"use strict";const keybindList={ondown:{},onup:{},onpress:{}};class KeyBind{static createSetup(e,t,s){return t.key=t?.key??"A",t.shiftKey=t?.shiftKey??!1,t.altKey=t?.altKey??!1,t.ctrlKey=t?.ctrlKey??!1,t.metaKey=t?.metaKey??!1,keybindList[`on${e}`][JSON.stringify(t).toLowerCase()]=s,class{static editKey(o){return delete keybindList[`on${e}`][JSON.stringify(t).toLowerCase()],t.key=o?.key??t.key,t.shiftKey=void 0!==o?.shiftKey?o.shiftKey:t.shiftKey,t.altKey=void 0!==o?.altKey?o.altKey:t.altKey,t.ctrlKey=void 0!==o?.ctrlKey?o.ctrlKey:t.ctrlKey,t.metaKey=void 0!==o?.metaKey?o.metaKey:t.metaKey,keybindList[`on${e}`][JSON.stringify(t).toLowerCase()]=s,this}static editCallback(s){return keybindList[`on${e}`][JSON.stringify(t).toLowerCase()]=s,this}static getStrings(e){const s=[t.key.toUpperCase(),void 0,void 0,void 0,void 0];return t.shiftKey&&(s[1]="Shift"),t.ctrlKey&&(s[2]="Ctrl"),t.meta&&(s[3]="Window"),t.altKey&&(s[4]="Alt"),e?s.filter((e=>void 0!==e)):s}}}}document.addEventListener("keydown",(e=>{(keybindList.ondown[JSON.stringify({key:e.key,shiftKey:e.shiftKey,altKey:e.altKey,ctrlKey:e.ctrlKey,metaKey:e.metaKey}).toLowerCase()]??(()=>{}))(e)})),document.addEventListener("keyup",(e=>{(keybindList.onup[JSON.stringify({key:e.key,shiftKey:e.shiftKey,altKey:e.altKey,ctrlKey:e.ctrlKey,metaKey:e.metaKey}).toLowerCase()]??(()=>{}))(e)})),document.addEventListener("keypress",(e=>{(keybindList.onpress[JSON.stringify({key:e.key,shiftKey:e.shiftKey,altKey:e.altKey,ctrlKey:e.ctrlKey,metaKey:e.metaKey}).toLowerCase()]??(()=>{}))(e)}));class ElementEvent{static create(e,t){Object.keys(t).forEach((s=>e.addEventListener(s,t[s])))}}class GetElement{static id(e,t){return t?GetElement.selector(`[id="${e}"]`,t):GetElement.selector(`[id="${e}"]`)}static ids(e,t){return Array.from(e,(e=>GetElement.id(e,t)))}static class(e,t){return t?t.getElementsByClassName(e):document.getElementsByClassName(e)}static tag(e,t){return t?t.getElementsByTagName(e):document.getElementsByTagName(e)}static name(e,t){return t?t.getElementsByName(e):document.getElementsByName(e)}static selector(e,t){return t?t.querySelector(e):document.querySelector(e)}static selectors(e,t){return t?t.querySelectorAll(e):document.querySelectorAll(e)}static body(){return this.selector('[class="body"]',document.body)}}class ElementCSS{static set(e,t){return Object.keys(t).forEach((s=>{e.style[s]=t[s]})),{get:t=>ElementCSS.get(e,t),set:t=>ElementCSS.set(e,t)}}static get(e,t){if(t){const s={};return t.forEach((t=>s[t]=e.style[t])),s}return e.style}}class ElementAttribute{static set(e,t){return Object.keys(t).forEach((s=>{e.setAttribute(s,t[s])})),{set:t=>ElementAttribute.set(e,t),get:t=>ElementAttribute.get(e,t)}}static get(e,t){let s;return 1===t.length?s=e.getAttribute(t[0]):(s={},t.forEach((t=>s[t]=e.getAttribute(t)))),s}}class ElementClass{static add(e,t="classname"){return e.classList.add(t),{add:t=>ElementClass.add(e,t),remove:t=>ElementClass.remove(e,t),toggle:(t,s)=>ElementClass.toggle(e,t,s)}}static remove(e,t="classname"){return e.classList.remove(t),{add:t=>ElementClass.add(e,t),remove:t=>ElementClass.remove(e,t),toggle:(t,s)=>ElementClass.toggle(e,t,s)}}static get(e,t){return t?e.classList.includes(t):e.classList}static toggle(e,t,s){return Array.from(e.classList).includes(t)?(s&&ElementClass.add(e,s),ElementClass.remove(e,t)):(s&&ElementClass.remove(e,s),ElementClass.add(e,t)),{add:t=>ElementClass.add(e,t),remove:t=>ElementClass.remove(e,t),toggle:(t,s)=>ElementClass.toggle(e,t,s)}}static setNode(e){return{add:t=>ElementClass.add(e,t),remove:t=>ElementClass.remove(e,t),toggle:(t,s)=>ElementClass.toggle(e,t,s)}}}class ElementToggle{static create(e,t,s,o=(()=>{}),a="classname"){const r=ElementAttribute.set(e,{toggle:`${s}`}),n=ElementClass.add(e,s?t:a);return e.onclick=e=>{n.toggle(t,a),o(e,"true"===r.set({toggle:"false"===r.get(["toggle"])}).get(["toggle"]))},class{static click(){return e.click(),this}static setValue(e){return r.get(["toggle"])!==`${e}`&&n.toggle(t,a),r.set({toggle:`${e}`}),this}}}static createRatio(e,t,s=0,o=((e=new Event,t=0)=>{}),a="classname"){return e.forEach(((r,n)=>{ElementClass.add(r,s===n?t:a),r.onclick=i=>{ElementClass.toggle(r,t,a),ElementClass.toggle(e[s],t,a),s=n,o(i,n)}})),class{static click(t){return e[t]?.click(),this}static setValue(o){return ElementClass.toggle(e[o],t,a),ElementClass.toggle(e[s],t,a),s=o,this}}}}const dialogList=[];KeyBind.createSetup("down",{key:"escape"},(()=>{dialogList.length>0&&dialogList[dialogList.length-1].hide()}));class Dialog{constructor(e,t=1,s=(()=>{}),o=(()=>{this.hideDialog()}),a){this.background=document.createElement("div"),this.onCloseCallback=null,this.onShow=s,this.onClose=o,this.autoHideDialogOnClose=!0,"CreateNode"===e.constructor.name&&(e=e.getNode()),e&&(this.background.appendChild(e),ElementCSS.set(e,{position:"absolute",left:"50%",top:"50%",transform:"translate(-50%, -50%)"})),a?a.onclick=()=>this.hide():GetElement.id("close",this.background).onclick=()=>this.hide(),ElementCSS.set(this.background,{backgroundColor:`rgba(0, 0, 0, ${t})`,position:"absolute",left:"0px",top:"0px",width:"100%",height:"100%",display:"none"})}static setup(e,t=1,s=(()=>{}),o=(()=>{}),a){return new Dialog(e,t,s,o,a).create()}create(){return document.body.appendChild(this.background),this}show(e){return this.onShow(new CreateNode(this.background),e),ElementCSS.set(this.background,{display:"",zIndex:1e4+dialogList.length}),dialogList.push(this),this}hide(){return this.onClose(new CreateNode(this.background),this.onCloseCallback),dialogList.pop(this),this.autoHideDialogOnClose&&this.hideDialog(),delete this.onCloseCallback,this}hideDialog(){ElementCSS.set(this.background,{display:"none"})}editDialog(e=(()=>{})){return e(new CreateNode(this.background)),this}release(){document.body.removeChild(this.background)}setOnCloseData(e){this.onCloseCallback=e}}class CreateNode{constructor(e,t){this.node="string"==typeof e?document.createElement(e):"CreateNode"===e.constructor.name?e.getNode():e,t&&this.addToNode(t)}setCSS(e){return ElementCSS.set(this.node,e),this}setText(e){return this.node.innerText=e,this}addText(e){return this.node.innerText+=e,this}setHTML(e){return this.node.innerHTML=e,this}addHTML(e){return this.node.innerHTML=e,this}setAttribute(e){return ElementAttribute.set(this.node,e),this}getAttribute(e){return ElementAttribute.get(this.node,e)}setClass(e){const t=ElementClass.setNode(this.node);return e.forEach((e=>t.add(e))),this}getClass(e){return ElementClass.get(this.node,e)}removeClass(e){const t=ElementClass.setNode(this.node);return e.forEach((e=>t.remove(e))),this}toggleClass(e,t="classname"){return ElementClass.setNode(this.node).toggle(e,t),this}setEvent(e){return ElementEvent.create(this.node,e),this}setProperty(e=new HTMLElement){return Object.keys(e).forEach((t=>this.node[t]=e[t])),this}getNode(e){return e?(e(this.node),this):this.node}addToNode(e){try{"CreateNode"===e.constructor.name?e.getNode().appendChild(this.node):e.appendChild(this.node)}catch(t){console.error(t),console.log(e)}return this}appendNode(e){return"Array"===e.constructor.name?e.forEach((e=>{"CreateNode"===e.constructor.name?e.addToNode(this.node):this.node.appendChild(e)})):"CreateNode"===e.constructor.name?e.addToNode(this.node):this.node.appendChild(e),this}release(){this.node.remove()}removeChild(e=void 0){let t;return t=e?this.node.removeChild(e):Array.from({length:this.node.childNodes.length},(e=>this.node.removeChild(this.node.childNodes[0]))),{parent:this,childNodes:t}}clone(e=!0){const t=new CreateNode(this.node.cloneNode());return e&&this.node.childNodes.forEach((e=>t.appendNode(new CreateNode(e).clone()))),t}visibleToggle(){return this.node.style.display="none"===this.node.style.display?"":"none",this}getChild(e,t=(()=>{})){return t(new CreateNode(GetElement.id(e,this.node))),this}setAnimate(e,t=(()=>{})){return(async()=>{for(const t of e)await new Promise((e=>{this.setCSS(t.css),setTimeout(e,t?.duration??0)}));t(this)})(),this}insertNode(e,t){e=new CreateNode(e).getNode();const s=Array.from(this.node.childNodes).filter((e=>"#"!==e.nodeName[0]));return this.node.insertBefore(e,s[t]),this}insertToNode(e,t){return new CreateNode(e).insertNode(this.node,t),this}}class PageDisplay{static setTitle(e="Page"){return document.title=e,this}static importDialogFile(e=""){return fetch(e).then((e=>e.text())).then((e=>{new CreateNode("div").setCSS({display:"none"}).addHTML(e).addToNode(document.body)})),this}static importCSS(e){return e&&("string"==typeof e?new CreateNode("link").setProperty({rel:"stylesheet",href:e}).addToNode(document.head):e.forEach((e=>new CreateNode("link").setProperty({rel:"stylesheet",href:e}).addToNode(document.head)))),this}static setIcon(e){return GetElement.selector('[rel="icon"]')?GetElement.selector('[rel="icon"]').href=e:new CreateNode("link").setAttribute({rel:"icon",type:"image/x-icon",href:e}).addToNode(document.head),this}static setGraph(e={facebook:{type:void 0,title:void 0,description:void 0,image:void 0,url:void 0},twitter:{card:void 0,title:void 0,description:void 0,image:void 0,url:void 0}}){const{facebook:t,twitter:s}=e;return t?.type&&new CreateNode("meta").setAttribute({property:"og:type",content:t.type}).addToNode(document.head),t?.title&&new CreateNode("meta").setAttribute({property:"og:title",content:t.title}).addToNode(document.head),t?.description&&new CreateNode("meta").setAttribute({property:"og:description",content:t.description}).addToNode(document.head),t?.image&&new CreateNode("meta").setAttribute({property:"og:image",content:t.image}).addToNode(document.head),t?.url&&new CreateNode("meta").setAttribute({property:"og:url",content:t.url}).addToNode(document.head),s?.card&&new CreateNode("meta").setAttribute({property:"twitter:card",content:t.card}).addToNode(document.head),s?.title&&new CreateNode("meta").setAttribute({property:"twitter:title",content:t.title}).addToNode(document.head),s?.description&&new CreateNode("meta").setAttribute({property:"twitter:description",content:t.description}).addToNode(document.head),s?.image&&new CreateNode("meta").setAttribute({property:"twitter:image",content:t.image}).addToNode(document.head),s?.url&&new CreateNode("meta").setAttribute({property:"twitter:url",content:t.url}).addToNode(document.head),this}}const DownloadFile=(e,t="content.txt",s)=>{let o=e;"object"==typeof e&&(o=URL.createObjectURL(e)),s&&(o=`data:text/plain;charset=utf-8,${encodeURIComponent(e)}`),new CreateNode("a").setCSS({display:"none"}).setProperty({href:o,download:t}).getNode((e=>{e.click(),URL.revokeObjectURL(o)})).release()};class ImportFile{static setup(e,t=(()=>{}),s=void 0,o=!1,a=!0,r=0,n=(()=>{}),i=(()=>{})){const d=e=>{if(void 0===s||s.includes(e.type)||s===e.type){const s=new FileReader;s.onload=s=>t(o?s.currentTarget.result.split(",")[1]:s.currentTarget.result,e.name,e.type),s.readAsDataURL(e)}};return"file"===(e=new CreateNode(e)).setAttribute({multiple:!0}).getAttribute(["type"])?e.setEvent({change:e=>{(async()=>{for(const t of Array.from(e.currentTarget.files))await new Promise((e=>{d(t),setTimeout(e,r)}))})(),a&&(e.currentTarget.value="")}}):e.setEvent({dragover:e=>e.preventDefault(),drop:e=>{e.preventDefault(),e.stopPropagation(),(async()=>{for(const t of Array.from(e.dataTransfer.files))await new Promise((e=>{d(t),setTimeout(e,r)}))})()}}),new CreateNode(e).setEvent({dragover:()=>n(new CreateNode(e)),drop:()=>i(new CreateNode(e)),dragleave:t=>{0===t.clientX&&0===t.clientY&&i(new CreateNode(e))}})}}class ImageHandle{static getImageData(e,t,s){const o=new Image;o.src=e,o.onload=()=>{(void 0===s||s<=o.height)&&(s=o.height),new CreateNode("canvas").setProperty({width:o.width*(s/o.height),height:o.height*(s/o.height)}).getNode((e=>{const a=e.getContext("2d");a.drawImage(o,0,0,o.width,o.height,0,0,e.width,e.height),t(a.getImageData(0,0,o.width*(s/o.height),o.height*(s/o.height)).data,{width:e.width,height:e.height}),o.remove()})).release()}}static dataToImage(e,t={width:64,height:64},s=(()=>{})){new CreateNode("canvas").setProperty(t).getNode((o=>{const a=new ImageData(t.width,t.height,{colorSpace:"srgb"});a.data.set(e),o.getContext("2d").putImageData(a,0,0),s(o.toDataURL().split(",")[1])}))}static getPixel(e,t){return[(e=new Uint8Array(e))[t*=4],e[t+1],e[t+2],e[t+3]]}static forEachFixel(e,t){e=Array.from(e);for(let s=0;s<e.length/4;s++){const o=4*s;t(e[o],e[o+1],e[o+2],e[o+3],s)}}}class Handle{static arrayToString(e){return(new TextDecoder).decode(new Uint8Array(e))}}class HTML{static pageDisplay=PageDisplay;static keyBind=KeyBind;static event=ElementEvent;static get=GetElement;static CSS=ElementCSS;static attribute=ElementAttribute;static class=ElementClass;static toggle=ElementToggle;static dialog=Dialog;static create=CreateNode;static importFile=ImportFile;static imageHandle=ImageHandle;static handle=Handle;static downloadFile=DownloadFile}